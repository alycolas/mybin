#!/bin/sh

export http_proxy="127.0.0.1:8087"

trap "exit 1" HUP INT PIPE QUIT TERM
trap "rm /tmp/tmp$$" EXIT

page=1
j=1

for i in `seq $2 $3`
#for i in {$2..$3} 
do
	echo $i
	wget --user-agent=Opera/9.80\ \(X11\;\ Linux\ i686\)\ Presto/2.12.388\ Version/12.15 "http://$1.tumblr.com/page/$i" -O - |
	# curl http://$1.tumblr.com/page/$i |
	sed -n -e "s/.*\"\(http:\/\/$1.tumblr.com\/post\/...........\)\".*/\1/p" | uniq	|
	while read k
	do
		echo $k
		wget -T3 --user-agent=Opera/9.80\ \(X11\;\ Linux\ i686\)\ Presto/2.12.388\ Version/12.15 "$k" -O /tmp/tmp$$

		if [[ $j = 11 ]]
		then
			j=1
			(( page++ ))
		fi

		if ! grep og:image /tmp/tmp$$
		#if ! grep -E '^\s*<img src=' /tmp/tmp$$ 
		then
			if ! grep twitter:image /tmp/tmp$$ 
			then
				echo $k >&2
			else
				((++j))
			fi
		else
			((++j))
		fi | 
		cut -d \" -f32 | 
		sed -e "s/^.*$/<img src=\"&\" style=\"margin:2\"\/>/" >> $1$2-$3${page}.html

		(( j++ ))

		rm /tmp/tmp$$

	done 2>/dev/null
done
# opera list_`date|sed s/\ /_/g`.html
